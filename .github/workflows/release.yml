name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      build_linux:
        description: 'Build Linux'
        type: boolean
        default: true
      build_windows:
        description: 'Build Windows'
        type: boolean
        default: true

jobs:
  # Linux build
  release-linux:
    if: github.event_name == 'push' || inputs.build_linux
    permissions:
      contents: write
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
          cache-on-failure: true

      - name: Install dependencies (Ubuntu)
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Install frontend dependencies
        run: pnpm install

      - name: Build the app
        run: pnpm tauri build

      - name: List built artifacts
        run: |
          echo "=== AppImage files ==="
          ls -la src-tauri/target/release/bundle/appimage/ || true
          echo "=== DEB files ==="
          ls -la src-tauri/target/release/bundle/deb/ || true

      - name: Upload artifacts to MinIO
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.MINIO_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.MINIO_SECRET_KEY }}
          RELEASE_TAG: ${{ github.ref_name }}
        run: |
          MINIO_ENDPOINT="${{ secrets.MINIO_ENDPOINT }}"
          BUCKET="s3://claudit-releases"

          for file in src-tauri/target/release/bundle/appimage/*.AppImage; do
            [ -f "$file" ] && aws --endpoint-url "$MINIO_ENDPOINT" s3 cp "$file" "$BUCKET/${RELEASE_TAG}/" || true
          done
          for file in src-tauri/target/release/bundle/deb/*.deb; do
            [ -f "$file" ] && aws --endpoint-url "$MINIO_ENDPOINT" s3 cp "$file" "$BUCKET/${RELEASE_TAG}/" || true
          done

  # Windows build
  release-windows:
    if: github.event_name == 'push' || inputs.build_windows
    permissions:
      contents: write
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
          cache-on-failure: true

      - name: Install frontend dependencies
        run: pnpm install

      - name: Build the app
        run: pnpm tauri build

      - name: List built artifacts
        shell: bash
        run: |
          echo "=== MSI files ==="
          ls -la src-tauri/target/release/bundle/msi/ || true
          echo "=== NSIS files ==="
          ls -la src-tauri/target/release/bundle/nsis/ || true

      - name: Upload artifacts to MinIO
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.MINIO_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.MINIO_SECRET_KEY }}
          RELEASE_TAG: ${{ github.ref_name }}
        shell: bash
        run: |
          MINIO_ENDPOINT="${{ secrets.MINIO_ENDPOINT }}"
          BUCKET="s3://claudit-releases"

          for file in src-tauri/target/release/bundle/nsis/*.exe; do
            [ -f "$file" ] && aws --endpoint-url "$MINIO_ENDPOINT" s3 cp "$file" "$BUCKET/${RELEASE_TAG}/" || true
          done
          for file in src-tauri/target/release/bundle/msi/*.msi; do
            [ -f "$file" ] && aws --endpoint-url "$MINIO_ENDPOINT" s3 cp "$file" "$BUCKET/${RELEASE_TAG}/" || true
          done
